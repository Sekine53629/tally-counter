<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>è¨¼æ‹ ç‰©ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ v3</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700&family=JetBrains+Mono:wght@500;600;700&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  :root{
    --bg:#0f1117;--surface:#1a1d27;--surface2:#232733;--border:#2e3345;
    --text:#e8eaed;--text2:#8b90a0;--accent:#3b82f6;--accent2:#2563eb;
    --green:#10b981;--orange:#f59e0b;--red:#ef4444;--purple:#8b5cf6;--cyan:#06b6d4;--pink:#ec4899;
  }
  body{font-family:'Noto Sans JP',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}

  /* Header */
  .header{padding:12px 16px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;position:sticky;top:0;z-index:50}
  .header h1{font-size:15px;font-weight:700;flex:1}
  .header .total{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;color:var(--accent)}
  .header .sub{font-size:11px;color:var(--text2);font-family:'JetBrains Mono',monospace}

  /* Month selector */
  .month-bar{display:flex;overflow-x:auto;gap:4px;padding:10px 12px;background:var(--surface);border-bottom:1px solid var(--border);scrollbar-width:none;-ms-overflow-style:none}
  .month-bar::-webkit-scrollbar{display:none}
  .mo-btn{
    flex-shrink:0;padding:6px 12px;border-radius:6px;border:1px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:11px;font-family:'JetBrains Mono',monospace;
    font-weight:600;cursor:pointer;transition:all 0.15s;white-space:nowrap;position:relative;
  }
  .mo-btn.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  .mo-btn .cnt{
    position:absolute;top:-6px;right:-6px;background:var(--red);color:#fff;
    font-size:9px;min-width:16px;height:16px;border-radius:8px;display:flex;
    align-items:center;justify-content:center;padding:0 4px;
  }
  .mo-btn .cnt.zero{display:none}

  /* FY separator */
  .fy-sep{flex-shrink:0;display:flex;align-items:center;padding:0 4px;font-size:9px;color:var(--text2);font-weight:700}

  /* Tab bar */
  .tabs{display:flex;gap:2px;padding:8px 12px;background:var(--bg)}
  .tab{
    flex:1;padding:8px;border-radius:7px;text-align:center;font-size:12px;font-weight:600;
    cursor:pointer;color:var(--text2);background:var(--surface);border:1px solid var(--border);
    transition:all 0.15s;
  }
  .tab.active{background:var(--accent);color:#fff;border-color:var(--accent)}

  /* === INPUT MODE === */
  .input-area{padding:12px}
  .section-label{font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding:0 2px}
  .dest-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:14px}
  .dest-btn{
    padding:14px 8px;border-radius:10px;border:2px solid var(--border);background:var(--surface);
    text-align:center;cursor:pointer;transition:all 0.15s;
  }
  .dest-btn .name{font-size:13px;font-weight:600}
  .dest-btn.selected{border-color:var(--accent);background:rgba(59,130,246,0.1)}
  .dest-btn.selected .name{color:var(--accent)}

  .flag-row{display:flex;gap:8px;margin-bottom:14px}
  .flag-btn{
    flex:1;padding:12px 8px;border-radius:10px;border:2px solid var(--border);background:var(--surface);
    text-align:center;cursor:pointer;transition:all 0.15s;
  }
  .flag-btn .icon{font-size:20px}
  .flag-btn .label{font-size:11px;font-weight:600;margin-top:4px}
  .flag-btn.on{border-color:var(--orange);background:rgba(245,158,11,0.1)}
  .flag-btn.on .label{color:var(--orange)}

  .register-btn{
    width:100%;padding:16px;border-radius:12px;border:none;font-family:'Noto Sans JP',sans-serif;
    font-size:16px;font-weight:700;cursor:pointer;transition:all 0.15s;
    display:flex;align-items:center;justify-content:center;gap:8px;
  }
  .register-btn.ready{background:var(--accent);color:#fff}
  .register-btn.ready:active{transform:scale(0.97);background:var(--accent2)}
  .register-btn.disabled{background:var(--surface2);color:var(--text2);cursor:not-allowed}

  .toast{
    position:fixed;bottom:80px;left:50%;transform:translateX(-50%);
    padding:10px 20px;border-radius:10px;font-size:13px;font-weight:600;
    opacity:0;transition:opacity 0.3s;pointer-events:none;z-index:100;
    background:var(--green);color:#fff;
  }
  .toast.show{opacity:1}
  .toast.undo{background:var(--orange)}

  .recent{margin-top:14px}
  .recent-title{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .recent-title span{font-size:11px;color:var(--text2);font-weight:600}
  .log-item{
    display:flex;align-items:center;gap:8px;padding:8px 10px;background:var(--surface);
    border:1px solid var(--border);border-radius:8px;margin-bottom:4px;font-size:12px;
    animation:slideIn 0.2s ease;
  }
  @keyframes slideIn{from{opacity:0;transform:translateY(-8px)}to{opacity:1;transform:none}}
  .log-item .num{font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--accent);min-width:28px}
  .log-item .dest-tag{padding:2px 8px;border-radius:4px;font-size:10px;font-weight:700}
  .log-item .flag-tag{padding:2px 6px;border-radius:4px;font-size:9px;font-weight:700}
  .log-item .undo-btn{
    margin-left:auto;padding:3px 8px;border-radius:4px;border:1px solid var(--border);
    background:var(--surface2);color:var(--text2);font-size:10px;cursor:pointer;font-family:'Noto Sans JP',sans-serif;
  }

  /* === SUMMARY === */
  .summary{padding:12px}
  .summary-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px}
  .summary-card h3{font-size:13px;font-weight:700;margin-bottom:10px;display:flex;align-items:center;gap:6px}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(100px,1fr));gap:8px}
  .s-cell{background:var(--surface2);border-radius:8px;padding:10px;text-align:center}
  .s-cell .lbl{font-size:10px;color:var(--text2);font-weight:600}
  .s-cell .val{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;margin-top:4px}

  .matrix{width:100%;border-collapse:collapse;font-size:11px;margin-top:8px}
  .matrix th,.matrix td{padding:6px 4px;text-align:center;border-bottom:1px solid var(--border)}
  .matrix th{color:var(--text2);font-weight:600;font-size:10px}
  .matrix td.lc{text-align:left;font-weight:600}
  .matrix .hi{color:var(--accent);font-weight:700}
  .matrix .warn{color:var(--orange);font-weight:700}

  .hours-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:10px}
  .h-cell{background:var(--surface2);border-radius:8px;padding:10px;text-align:center}
  .h-cell .lbl{font-size:10px;color:var(--text2)}
  .h-cell .val{font-family:'JetBrains Mono',monospace;font-size:20px;font-weight:700;margin-top:2px}

  .export-bar{display:flex;gap:6px;margin-top:12px}
  .export-btn{
    flex:1;padding:10px;border-radius:8px;border:1px solid var(--border);background:var(--surface);
    color:var(--text);font-family:'Noto Sans JP',sans-serif;font-size:12px;font-weight:600;
    cursor:pointer;text-align:center;
  }
  .export-btn:hover{border-color:var(--accent);color:var(--accent)}

  .danger-zone{margin-top:20px;padding:14px;border:1px solid var(--red);border-radius:10px;background:rgba(239,68,68,0.05)}
  .danger-zone h3{font-size:12px;color:var(--red);margin-bottom:8px}
  .danger-btn{
    padding:8px 16px;border-radius:6px;border:1px solid var(--red);background:transparent;
    color:var(--red);font-family:'Noto Sans JP',sans-serif;font-size:12px;cursor:pointer;
  }
</style>
</head>
<body>

<div class="header">
  <h1>ğŸ“‹ è¨¼æ‹ ç‰©ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼</h1>
  <div style="text-align:right">
    <div class="total" id="totalCount">0</div>
    <div class="sub" id="totalSub">å…¨æœˆåˆè¨ˆ</div>
  </div>
</div>
<div class="month-bar" id="monthBar"></div>
<div class="tabs">
  <div class="tab active" id="tabInput" onclick="switchTab('input')">ğŸ“ å…¥åŠ›</div>
  <div class="tab" id="tabSummary" onclick="switchTab('summary')">ğŸ“Š é›†è¨ˆ</div>
</div>

<div id="inputView"><div class="input-area">
  <div class="section-label">ğŸ“® æå‡ºå…ˆï¼ˆã‚¿ãƒƒãƒ—ã§é¸æŠï¼‰</div>
  <div class="dest-grid" id="destGrid"></div>
  <div class="section-label">ğŸ·ï¸ ãƒ•ãƒ©ã‚°</div>
  <div class="flag-row" id="flagRow"></div>
  <button class="register-btn disabled" id="registerBtn" onclick="registerDoc()">æå‡ºå…ˆã‚’é¸æŠã—ã¦ãã ã•ã„</button>
  <div class="recent" id="recentArea"></div>
</div></div>

<div id="summaryView" style="display:none"><div class="summary" id="summaryContent"></div></div>
<div class="toast" id="toast"></div>

<script>
const DESTS = [
  { id:'hokenjo', name:'ä¿å¥æ‰€', short:'ä¿å¥æ‰€', color:'#3b82f6' },
  { id:'kousekyoku', name:'åšç”Ÿå±€', short:'åšç”Ÿå±€', color:'#10b981' },
  { id:'shinkoukyoku', name:'æŒ¯èˆˆå±€', short:'æŒ¯èˆˆå±€', color:'#8b5cf6' },
  { id:'jiritsu_hoken', name:'è‡ªç«‹æ”¯æ´(ä¿å¥æ‰€)', short:'è‡ªç«‹ä¿', color:'#06b6d4' },
  { id:'roudoukyoku', name:'åŠ´åƒå±€', short:'åŠ´åƒå±€', color:'#f59e0b' },
  { id:'other', name:'ãã®ä»–', short:'ä»–', color:'#6b7280' },
];

const FLAGS = [
  { id:'kanyaku', name:'ç®¡è–¬å¤‰æ›´', icon:'ğŸ‘¤', color:'#f59e0b' },
  { id:'hijokin', name:'éå¸¸å‹¤', icon:'ğŸ•', color:'#8b5cf6' },
  { id:'shinki', name:'æ–°è¦é–‹è¨­', icon:'ğŸª', color:'#10b981' },
];

// åŠ é‡å·¥æ•°ï¼ˆh/ä»¶ï¼‰
const HRS = {
  base:     { lo:2,  mid:3,  hi:4 },   // éå¸¸å‹¤ãƒ»åšç”Ÿå±€å˜ä½“
  standard: { lo:6,  mid:8,  hi:10 },   // é€šå¸¸(ä¿å¥æ‰€+åšç”Ÿå±€)
  kanyaku:  { lo:10, mid:14, hi:18 },   // ç®¡è–¬å¤‰æ›´
};

// Months
const MONTHS = [];
for(let y=2023;y<=2026;y++){const sm=y===2023?4:1,em=y===2026?4:12;for(let m=sm;m<=em;m++)MONTHS.push({code:`${y}${String(m).padStart(2,'0')}`,y,m});}
function getFY(c){const y=+c.slice(0,4),m=+c.slice(4);return m>=4?y:y-1;}

// State
let data={}, curMonth=null, selDest=null, flags={};
const SK='evidence_counter_v3';
function save(){localStorage.setItem(SK,JSON.stringify(data));}
function load(){try{const r=localStorage.getItem(SK);if(r)data=JSON.parse(r);}catch(e){}}

// Month bar
function renderMonths(){
  const b=document.getElementById('monthBar');let h='',pf=null;
  MONTHS.forEach(mo=>{
    const fy=getFY(mo.code);
    if(fy!==pf){const c={2023:'#3b82f6',2024:'#10b981',2025:'#f59e0b'};h+=`<div class="fy-sep" style="color:${c[fy]||'#888'}">${fy}å¹´åº¦</div>`;pf=fy;}
    const n=(data[mo.code]||[]).length;
    h+=`<div class="mo-btn ${curMonth===mo.code?'active':''}" onclick="selMonth('${mo.code}')">${mo.m}æœˆ<span class="cnt ${n?'':'zero'}">${n}</span></div>`;
  });
  b.innerHTML=h;
  setTimeout(()=>{const a=b.querySelector('.active');if(a)a.scrollIntoView({behavior:'smooth',block:'nearest',inline:'center'});},50);
}

function renderDests(){
  document.getElementById('destGrid').innerHTML=DESTS.map(d=>`
    <div class="dest-btn ${selDest===d.id?'selected':''}" onclick="pickDest('${d.id}')" style="${selDest===d.id?`border-color:${d.color}`:''}">
      <div class="name" style="${selDest===d.id?`color:${d.color}`:''}">${d.name}</div>
    </div>`).join('');
}

function renderFlags(){
  document.getElementById('flagRow').innerHTML=FLAGS.map(f=>`
    <div class="flag-btn ${flags[f.id]?'on':''}" onclick="togFlag('${f.id}')" style="${flags[f.id]?`border-color:${f.color};background:${f.color}15`:''}">
      <div class="icon">${f.icon}</div>
      <div class="label" style="${flags[f.id]?`color:${f.color}`:''}">${f.name}</div>
    </div>`).join('');
}

function renderBtn(){
  const b=document.getElementById('registerBtn');
  if(!selDest){b.className='register-btn disabled';b.innerHTML='æå‡ºå…ˆã‚’é¸æŠã—ã¦ãã ã•ã„';return;}
  const d=DESTS.find(x=>x.id===selDest);
  const fl=FLAGS.filter(f=>flags[f.id]).map(f=>f.icon+f.name);
  b.className='register-btn ready';
  b.innerHTML=`âœ… ç™»éŒ²ï¼š${d.name}${fl.length?' ï¼‹ '+fl.join(' '):''}`;
}

function renderRecent(){
  const a=document.getElementById('recentArea'),docs=data[curMonth]||[];
  if(!docs.length){a.innerHTML='';return;}
  const recent=docs.slice(-10).reverse();
  let h=`<div class="recent-title"><span>æœ€è¿‘ã®ç™»éŒ²ï¼ˆ${docs.length}ä»¶ï¼‰</span></div>`;
  recent.forEach((doc,i)=>{
    const idx=docs.length-i,d=DESTS.find(x=>x.id===doc.dest);
    const ft=(doc.flags||[]).map(fid=>{const f=FLAGS.find(x=>x.id===fid);return f?`<span class="flag-tag" style="background:${f.color}20;color:${f.color}">${f.icon}${f.name}</span>`:''}).join('');
    h+=`<div class="log-item"><span class="num">${String(idx).padStart(3,'0')}</span><span class="dest-tag" style="background:${d.color}20;color:${d.color}">${d.name}</span>${ft}<button class="undo-btn" onclick="undo(${docs.length-1-i})">å–æ¶ˆ</button></div>`;
  });
  a.innerHTML=h;
}

function updateTotal(){
  const md=data[curMonth]||[],all=Object.values(data).reduce((a,d)=>a+d.length,0);
  document.getElementById('totalCount').textContent=all;
  document.getElementById('totalSub').textContent=curMonth?`ã“ã®æœˆ: ${md.length}ä»¶ / å…¨ä½“: ${all}ä»¶`:'å…¨æœˆåˆè¨ˆ';
}

// Actions
function selMonth(c){curMonth=c;selDest=null;flags={};renderMonths();renderDests();renderFlags();renderBtn();renderRecent();updateTotal();}
function pickDest(id){selDest=selDest===id?null:id;renderDests();renderBtn();if(navigator.vibrate)navigator.vibrate(20);}
function togFlag(id){flags[id]=!flags[id];renderFlags();renderBtn();if(navigator.vibrate)navigator.vibrate(20);}

function registerDoc(){
  if(!selDest||!curMonth)return;
  if(!data[curMonth])data[curMonth]=[];
  data[curMonth].push({dest:selDest,flags:FLAGS.filter(f=>flags[f.id]).map(f=>f.id),ts:new Date().toISOString()});
  save();
  const d=DESTS.find(x=>x.id===selDest);
  toast(`âœ… #${data[curMonth].length} ${d.name} ç™»éŒ²`);
  if(navigator.vibrate)navigator.vibrate([30,50,30]);
  selDest=null;flags={};renderDests();renderFlags();renderBtn();renderRecent();renderMonths();updateTotal();
}

function undo(i){
  if(!curMonth||!data[curMonth])return;
  const doc=data[curMonth][i];if(!doc)return;
  const d=DESTS.find(x=>x.id===doc.dest);
  data[curMonth].splice(i,1);if(!data[curMonth].length)delete data[curMonth];
  save();toast(`â†© ${d.name} å–æ¶ˆ`,'undo');renderRecent();renderMonths();updateTotal();
}

function switchTab(t){
  document.getElementById('tabInput').className='tab'+(t==='input'?' active':'');
  document.getElementById('tabSummary').className='tab'+(t==='summary'?' active':'');
  document.getElementById('inputView').style.display=t==='input'?'':'none';
  document.getElementById('summaryView').style.display=t==='summary'?'':'none';
  if(t==='summary')renderSummary();
}

function toast(msg,type=''){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show '+type;setTimeout(()=>t.className='toast',1500);}

// Summary
function renderSummary(){
  const c=document.getElementById('summaryContent');
  const allDocs=[];Object.entries(data).forEach(([m,docs])=>docs.forEach(d=>allDocs.push({...d,month:m})));
  const mc=Object.keys(data).filter(k=>data[k].length>0).length;
  const tot=allDocs.length;

  const dc={},fc={};
  DESTS.forEach(d=>dc[d.id]=0);FLAGS.forEach(f=>fc[f.id]=0);
  allDocs.forEach(d=>{dc[d.dest]++;(d.flags||[]).forEach(f=>fc[f]=(fc[f]||0)+1);});

  const md={};
  MONTHS.forEach(mo=>{
    const docs=data[mo.code]||[],row={total:docs.length,d:{},f:{}};
    DESTS.forEach(d=>row.d[d.id]=0);FLAGS.forEach(f=>row.f[f.id]=0);
    docs.forEach(d=>{row.d[d.dest]++;(d.flags||[]).forEach(f=>row.f[f]=(row.f[f]||0)+1);});
    md[mo.code]=row;
  });

  function estHrs(docs){
    let h={lo:0,mid:0,hi:0};
    docs.forEach(d=>{
      const fls=d.flags||[];
      let t;
      if(fls.includes('kanyaku'))t=HRS.kanyaku;
      else if(d.dest==='kousekyoku'&&fls.includes('hijokin'))t=HRS.base;
      else t=HRS.standard;
      h.lo+=t.lo;h.mid+=t.mid;h.hi+=t.hi;
    });return h;
  }

  const th=estHrs(allDocs);
  const ah=mc>0?{lo:(th.lo/mc).toFixed(0),mid:(th.mid/mc).toFixed(0),hi:(th.hi/mc).toFixed(0)}:{lo:0,mid:0,hi:0};

  let html=`<div class="summary-card"><h3>ğŸ“Š å…¨ä½“ã‚µãƒãƒªãƒ¼</h3>
    <div class="summary-grid">
      <div class="s-cell"><div class="lbl">ç·æ›¸é¡æ•°</div><div class="val" style="color:var(--accent)">${tot}</div></div>
      <div class="s-cell"><div class="lbl">ç™»éŒ²æœˆæ•°</div><div class="val">${mc}</div></div>
      <div class="s-cell"><div class="lbl">æœˆå¹³å‡</div><div class="val">${mc?(tot/mc).toFixed(1):'-'}</div></div>
      <div class="s-cell"><div class="lbl">ç®¡è–¬å¤‰æ›´</div><div class="val" style="color:var(--orange)">${fc.kanyaku||0}</div></div>
      <div class="s-cell"><div class="lbl">éå¸¸å‹¤</div><div class="val" style="color:var(--purple)">${fc.hijokin||0}</div></div>
      <div class="s-cell"><div class="lbl">æ–°è¦é–‹è¨­</div><div class="val" style="color:var(--green)">${fc.shinki||0}</div></div>
    </div></div>`;

  html+=`<div class="summary-card"><h3>ğŸ“® æå‡ºå…ˆåˆ¥</h3>
    <div class="summary-grid">${DESTS.map(d=>`<div class="s-cell"><div class="lbl">${d.short}</div><div class="val" style="color:${d.color}">${dc[d.id]}</div></div>`).join('')}</div></div>`;

  html+=`<div class="summary-card"><h3>â±ï¸ æ¨å®šæ®‹æ¥­å·¥æ•°ï¼ˆåŠ é‡å¹³å‡ï¼‰</h3>
    <div style="font-size:11px;color:var(--text2);margin-bottom:8px">éå¸¸å‹¤(åšç”Ÿå±€ã®ã¿): ${HRS.base.mid}h ï¼ é€šå¸¸: ${HRS.standard.mid}h ï¼ ç®¡è–¬å¤‰æ›´: ${HRS.kanyaku.mid}h</div>
    <div class="hours-row">
      <div class="h-cell"><div class="lbl">ä¿å®ˆçš„</div><div class="val" style="color:var(--green)">${ah.lo}h</div><div class="lbl">æœˆå¹³å‡</div></div>
      <div class="h-cell"><div class="lbl">ä¸­é–“</div><div class="val" style="color:var(--accent)">${ah.mid}h</div><div class="lbl">æœˆå¹³å‡</div></div>
      <div class="h-cell"><div class="lbl">ç©æ¥µçš„</div><div class="val" style="color:var(--orange)">${ah.hi}h</div><div class="lbl">æœˆå¹³å‡</div></div>
    </div>
    <div style="font-size:10px;color:var(--text2);margin-top:8px;text-align:center">ç·è¨ˆ: ${th.lo}h ã€œ ${th.mid}h ã€œ ${th.hi}h</div></div>`;

  [2023,2024,2025].forEach(fy=>{
    const fm=MONTHS.filter(m=>getFY(m.code)===fy);
    const ft=fm.reduce((a,m)=>(md[m.code]?.total||0)+a,0);
    html+=`<div class="summary-card"><h3>${fy}å¹´åº¦ <span style="font-family:'JetBrains Mono',monospace;font-size:12px;color:var(--accent)">(${ft}ä»¶)</span></h3>
    <div style="overflow-x:auto"><table class="matrix"><tr><th style="text-align:left">æœˆ</th><th>è¨ˆ</th>${DESTS.slice(0,5).map(d=>`<th>${d.short}</th>`).join('')}<th>ç®¡è–¬</th><th>éå¸¸å‹¤</th></tr>
    ${fm.map(mo=>{const r=md[mo.code],t=r.total;return `<tr style="opacity:${t?1:0.4}"><td class="lc" style="cursor:pointer" onclick="selMonth('${mo.code}');switchTab('input')">${mo.m}æœˆ</td><td class="${t>=20?'warn':t?'hi':''}">${t||'-'}</td>${DESTS.slice(0,5).map(d=>`<td>${r.d[d.id]||'-'}</td>`).join('')}<td style="color:var(--orange)">${r.f.kanyaku||'-'}</td><td style="color:var(--purple)">${r.f.hijokin||'-'}</td></tr>`;}).join('')}
    <tr style="font-weight:700;border-top:2px solid var(--border)"><td class="lc">åˆè¨ˆ</td><td class="hi">${ft}</td>${DESTS.slice(0,5).map(d=>{const s=fm.reduce((a,m)=>(md[m.code]?.d[d.id]||0)+a,0);return`<td>${s||'-'}</td>`;}).join('')}<td style="color:var(--orange)">${fm.reduce((a,m)=>(md[m.code]?.f.kanyaku||0)+a,0)||'-'}</td><td style="color:var(--purple)">${fm.reduce((a,m)=>(md[m.code]?.f.hijokin||0)+a,0)||'-'}</td></tr>
    </table></div></div>`;
  });

  html+=`<div class="export-bar">
    <button class="export-btn" onclick="exportCSV()">ğŸ“¥ CSVå‡ºåŠ›</button>
    <button class="export-btn" onclick="exportJSON()">ğŸ’¾ JSONä¿å­˜</button>
    <button class="export-btn" onclick="importJSON()">ğŸ“‚ JSONèª­è¾¼</button>
  </div>`;

  html+=`<div class="danger-zone"><h3>âš  ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3><div style="display:flex;gap:8px">
    <button class="danger-btn" onclick="resetMo()">ã“ã®æœˆãƒªã‚»ãƒƒãƒˆ</button>
    <button class="danger-btn" onclick="resetAll()">å…¨ãƒ‡ãƒ¼ã‚¿ãƒªã‚»ãƒƒãƒˆ</button>
  </div></div>`;

  c.innerHTML=html;
}

// Export
function exportCSV(){
  let csv='month,seq,dest_id,dest_name,kanyaku,hijokin,shinki,timestamp\n';
  Object.keys(data).sort().forEach(m=>{
    (data[m]||[]).forEach((d,i)=>{
      const dest=DESTS.find(x=>x.id===d.dest),fl=d.flags||[];
      csv+=`${m},${i+1},${d.dest},${dest.name},${fl.includes('kanyaku')?1:0},${fl.includes('hijokin')?1:0},${fl.includes('shinki')?1:0},${d.ts}\n`;
    });
  });
  csv+='\næœˆåˆ¥é›†è¨ˆ\nmonth,total,ä¿å¥æ‰€,åšç”Ÿå±€,æŒ¯èˆˆå±€,è‡ªç«‹ä¿,åŠ´åƒå±€,ãã®ä»–,ç®¡è–¬å¤‰æ›´,éå¸¸å‹¤,æ–°è¦é–‹è¨­\n';
  MONTHS.forEach(mo=>{
    const docs=data[mo.code]||[];if(!docs.length)return;
    const dc={},fc={kanyaku:0,hijokin:0,shinki:0};DESTS.forEach(d=>dc[d.id]=0);
    docs.forEach(d=>{dc[d.dest]++;(d.flags||[]).forEach(f=>fc[f]=(fc[f]||0)+1);});
    csv+=`${mo.code},${docs.length},${DESTS.map(d=>dc[d.id]).join(',')},${fc.kanyaku},${fc.hijokin},${fc.shinki}\n`;
  });
  dl(csv,`evidence_count_${new Date().toISOString().slice(0,10)}.csv`,'text/csv');
}

function exportJSON(){dl(JSON.stringify(data,null,2),`evidence_data_${new Date().toISOString().slice(0,10)}.json`,'application/json');}

function importJSON(){
  const inp=document.createElement('input');inp.type='file';inp.accept='.json';
  inp.onchange=async e=>{const f=e.target.files[0];if(!f)return;try{const t=await f.text(),d=JSON.parse(t);if(confirm(`${Object.values(d).flat().length}ä»¶ã‚’èª­ã¿è¾¼ã¿ã¾ã™ã€‚ä¸Šæ›¸ãã—ã¾ã™ã‹ï¼Ÿ`)){data=d;save();renderAll();toast('âœ… èª­è¾¼å®Œäº†');}}catch(e){alert('èª­è¾¼å¤±æ•—: '+e.message);}};
  inp.click();
}

function dl(content,name,mime){
  const b=new Blob([new Uint8Array([0xEF,0xBB,0xBF]),content],{type:mime+';charset=utf-8'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download=name;a.click();
}

function resetMo(){
  if(!curMonth)return;const n=(data[curMonth]||[]).length;if(!n)return;
  if(!confirm(`${curMonth} ã® ${n}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
  delete data[curMonth];save();renderAll();toast('ğŸ—‘ å‰Šé™¤ã—ã¾ã—ãŸ','undo');
}
function resetAll(){
  const n=Object.values(data).flat().length;if(!n)return;
  if(!confirm(`å…¨ ${n}ä»¶ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`))return;
  if(!confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ'))return;
  data={};save();renderAll();toast('ğŸ—‘ å…¨å‰Šé™¤ã—ã¾ã—ãŸ','undo');
}

function renderAll(){renderMonths();renderDests();renderFlags();renderBtn();renderRecent();updateTotal();}

load();
const now=new Date(),dm=`${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}`;
curMonth=MONTHS.find(m=>m.code===dm)?dm:'202304';
renderAll();
</script>
</body>
</html>
